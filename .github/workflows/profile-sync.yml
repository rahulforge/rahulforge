name: Sync Live & Upcoming

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: cli/setup-gh@v3
      - name: Build sections
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LIVE=$(gh repo list rahulforge --json name,description,homepageUrl,repositoryTopics \
            --jq '.[] | select(.repositoryTopics[].name=="live") |
            "<td width=\"33%\" valign=\"top\"><h4>ðŸš€ " + .name + "</h4><p>" +
            (.description // "Live project") + "</p><a href=\"" +
            (.homepageUrl // ("https://github.com/rahulforge/" + .name)) +
            "\" target=\"_blank\">Visit â†’</a></td>"')

          UPCOMING=$(gh repo list rahulforge --json name,description,repositoryTopics \
            --jq '.[] | select(.repositoryTopics[].name=="upcoming") |
            "<td width=\"33%\" valign=\"top\"><h4>ðŸ§­ " + .name + "</h4><p>" +
            (.description // "Coming soon") + "</p></td>"')

          perl -0777 -i -pe "s|<!-- LIVE:START -->.*?<!-- LIVE:END -->|<!-- LIVE:START -->\n<table><tr>$LIVE</tr></table>\n<!-- LIVE:END -->|s" README.md
          perl -0777 -i -pe "s|<!-- UPCOMING:START -->.*?<!-- UPCOMING:END -->|<!-- UPCOMING:START -->\n<table><tr>$UPCOMING</tr></table>\n<!-- UPCOMING:END -->|s" README.md

      - name: Commit
        run: |
          git config user.name "rahulforge-bot"
          git config user.email "bot@users.noreply.github.com"
          git add README.md
          git commit -m "Auto-update Live & Upcoming" || exit 0
          git push
